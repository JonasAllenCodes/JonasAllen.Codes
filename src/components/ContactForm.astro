---
import directus from "../lib/directus";
import { createItem } from "@directus/sdk";

let firstName = "";
let lastName = "";
let email = "";
let message = "";
const errors = {
    username: "",
    firstName: "",
    lastName: "",
    email: "",
    message: "",
    submission: "",
}
let successMessage = "";
let formDisplay = "flex";

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const username = data.get("username").toString().trim();
        lastName = data.get("last-name").toString().trim();
        firstName = data.get("first-name").toString().trim();
        email = data.get("email").toString().trim();
        message = data.get("message").toString().trim();

        if (username) {
            errors.username +=
                "There is has been an error with your submission. If you are using an auto-fill for this form, please disable the form auto-fill. Then refresh the page, while holding the shift key to clear the cache on this page. Thank you and my apologies for any inconveniences.";
            throw new Error("Contact Form: And another bot bites the dust!");   
        }

        if (typeof firstName !== "string" || firstName.length < 1) {
            errors.firstName += "Pease enter your first name.";
        }

        if (typeof lastName !== "string" || lastName.length < 1) {
            errors.lastName += "Pease enter your last name.";
        }

        if (typeof email !== "string" || email.length < 1) {
            errors.email += "Pease enter your email.";
        }

        const hasErrors = Object.values(errors).some(msg => msg);
        if (!hasErrors) {
            await directus.request(
                createItem("contact_form", {
                    status: "open",
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    message: message,
                })
            )

            successMessage = "Your message has been successfully sent! I'll get back to you as soon as possible. Thank you for reahing out to me!";
            firstName = "";
            lastName = "";
            email = "";
            message = "";
            formDisplay = "none";
        }
    } catch (error) {
        if (error instanceof Error) {
            console.error(`${error.name}: ${error.message} \n\n${error.cause}`);
            errors.submission +=
                "There has been an error submitting your response. Please check your internet connection. If your interconnection seems fine try submitting from another browser or device. If problem persists you may need to try at another time.";
        }
    }
}
---

<h2>{!successMessage ? "Contact Me" : "Contact Form Submission Successful"}</h2>

{successMessage && <p>{successMessage}</p>}

<form method="POST" aria-hidden={successMessage ? "true": "false"}>
    {errors.submission && <p>{errors.submission}</p>}
    {errors.username && <p>{errors.username}</p>}
    <label class="hp-field">
        Username:
        <input type="text" name="username" autocomplete="off" />
    </label>
    <div>
        <label>
            First Name:
            <input type="text" name="first-name" value={firstName} required />
            {errors.firstName && <p>{errors.firstName}</p>}
        </label>
        <label>
            Last Name:
            <input type="text" name="last-name" value={lastName} required />
            {errors.lastName && <p>{errors.lastName}</p>}
        </label>
    </div>
    <label>
        Email:
        <input type="email" name="email" value={email} required />
        {errors.email && <p>{errors.email}</p>}
    </label>
    <label>
        Message:
        <textarea name="message" rows="8" cols="50">{message}</textarea>
    </label>
    <input type="submit" value="submit">
</form>

<style define:vars={{ formDisplay }}>
    form {
        display: var(--formDisplay);
        flex-direction: column;
    }
    .hp-field {
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        height: 0;
        width: 0;
        z-index: -1;
    }
</style>